//"use strict";

var url = require('url');
var http = require('http');

var postcss = require('postcss');
var sizeOf = require('image-size');

module.exports = postcss.plugin('padding', function padding(options) {

	options = options || {};

	return function (css, result) {

		css.walkRules(function(rule) {

			// Match the individual rule selector 
			if ( rule.nodes[0].name.indexOf('include') !== -1 ) { 

				var thisInclude = rule.nodes[0].params.split("(")[0];
			 	
				if (thisInclude === 'full-width' || thisInclude === 'image'){
					var params = rule.nodes[0].params
					var imageUrl = params.split("\'")[1];
					var urlWithPreset = imageUrl + '?$retina$';

					var options = url.parse(urlWithPreset);
					 
					var newParam;

					http.get(options, function (response) {
						var chunks = [];
							response.on('data', function (chunk) {
							chunks.push(chunk);
						}).on('end', function() {
							var buffer = Buffer.concat(chunks);
							var dimensions = sizeOf(buffer);

							var paddingBottom = (dimensions.height/2400) * 100;
							paddingBottom = paddingBottom.toFixed(3);
							paddingBottom = ', ' + paddingBottom + "% )";
							
							newParam = (params.substring(0, params.length - 1)) + paddingBottom;
						});
					});

				}

			}
		});
	}
});